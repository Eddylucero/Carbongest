{% extends 'plantilla.html' %}
{% load static %}
{% block contenido %}
<br><br>
<body>
  <h1 style="text-align:center">Listado de Proveedores</h1><br><br>
  <div class="d-flex justify-content-end">
    <button onclick="abrirModal()" class="btn btn-outline-success"><i class="fa fa-user-plus"></i> Nuevo Proveedor</button>
  </div>
  <br><br>

  <div>
    <table id="tblProveedores" class="table table-bordered">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Nombre</th>
          <th>RUC</th>
          <th>Teléfono</th>
          <th>Dirección</th>
          <th>Foto</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tablaProveedores"></tbody>
    </table>
  </div>

  <div class="modal fade" id="modalProveedor" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <form id="formProveedor" class="modal-content" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title">Proveedor</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="proveedorId" name="proveedorId">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="nombre" class="form-label">Nombre*</label>
                <input type="text" id="nombre" name="nombre" class="form-control" required>
              </div>
              <div class="mb-3">
                <label for="ruc" class="form-label">RUC*</label>
                <input type="text" id="ruc" name="ruc" class="form-control" required>
              </div>
              <div class="mb-3">
                <label for="telefono" class="form-label">Teléfono</label>
                <input type="text" id="telefono" name="telefono" class="form-control">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="direccion" class="form-label">Dirección*</label>
                <input type="text" id="direccion" name="direccion" class="form-control" required>
              </div>
              <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" id="email" name="email" class="form-control">
              </div>
              <div class="mb-3">
                <label for="foto" class="form-label">Foto</label>
                <input type="file" id="foto" name="foto" class="form-control" accept="image/*">
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">
            <i class="fa fa-times"></i> Cancelar
          </button>
          <button type="submit" class="btn btn-outline-success">
            <i class="fa fa-check"></i> Guardar
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    let myProveedorModal;

    document.addEventListener('DOMContentLoaded', () => {
      listadoProveedores();

      const modalElement = document.getElementById('modalProveedor');
      myProveedorModal = new bootstrap.Modal(modalElement);

      document.getElementById('formProveedor').addEventListener('submit', function (e) {
        e.preventDefault();
        const id = document.getElementById('proveedorId').value;
        const form = this;
        const formData = new FormData(form);
        if (id) {
          actualizarProveedor(id, formData);
        } else {
          nuevoProveedor(formData);
        }
      });

      modalElement.querySelector('.btn-close').addEventListener('click', cerrarModal);
      modalElement.querySelector('.btn-outline-danger').addEventListener('click', cerrarModal);
    });

    function listadoProveedores() {
      document.getElementById('tablaProveedores').innerHTML = `
        <tr>
          <td colspan="9" class="text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden"></span>
            </div>
          </td>
        </tr>`;
      
      fetch('/Proveedores/listado/')
        .then(response => {
          if (!response.ok) {
            throw new Error('Error en la respuesta del servidor');
          }
          return response.json();
        })
        .then(data => {
          if (!data || !data.proveedores) {
            throw new Error('Datos de proveedores no recibidos');
          }
          
          const tabla = document.getElementById('tablaProveedores');
          tabla.innerHTML = '';
          
          if (data.proveedores.length === 0) {
            tabla.innerHTML = `
              <tr>
                <td colspan="9" class="text-center">No hay proveedores registrados</td>
              </tr>`;
            return;
          }
          
          data.proveedores.forEach(prov => {
            const fechaCreacion = new Date(prov.fecha_creacion).toLocaleDateString();
            tabla.innerHTML += `
              <tr>
                <td>${prov.id}</td>
                <td>${prov.nombre}</td>
                <td>${prov.ruc}</td>
                <td>${prov.telefono || 'N/A'}</td>
                <td>${prov.direccion}</td>
                <td>${prov.foto ? `<img src="/media/${prov.foto}"` : 'Sin foto'}</td>
                <td>
                  <button class="btn btn-sm btn-outline-warning" onclick="editarProveedor(${prov.id})" title="Editar">
                    <i class="fa fa-pencil-alt"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete(${prov.id})" title="Eliminar">
                    <i class="fa fa-trash"></i>
                  </button>
                </td>
              </tr>
            `;
          });
        })
    }

    function abrirModal() {
      document.getElementById('formProveedor').reset();
      document.getElementById('proveedorId').value = '';
      myProveedorModal.show();
    }

    async function nuevoProveedor(formData) {
      Swal.fire({
        title: 'Guardando...',
        text: 'Por favor, espere.',
        didOpen: () => {
          Swal.showLoading();
        },
        allowOutsideClick: false,
        allowEscapeKey: false
      });

      try {
        const response = await fetch('/Proveedores/nuevo/', {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken
          },
          body: formData
        });
        
        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || 'Error en el servidor');
        }
        const data = await response.json();

        Swal.close();

        cerrarModal();
        Swal.fire({
          title: 'Éxito',
          text: data.mensaje || 'Proveedor registrado correctamente',
          icon: 'success'
        });
      } catch (error) {
        Swal.close();
        console.error('Error:', error);
        Swal.fire({
          title: 'Error',
          text: error.message || 'Error al registrar el proveedor',
          icon: 'error'
        });
      }
    }
    async function editarProveedor(id) {
      Swal.fire({
        title: 'Cargando datos...',
        text: 'Por favor, espere.',
        didOpen: () => {
          Swal.showLoading();
        },
        allowOutsideClick: false,
        allowEscapeKey: false
      });

      try {
        const response = await fetch(`/Proveedores/detalle/${id}/`);
        
        if (!response.ok) {
          throw new Error('Error al obtener datos del proveedor');
        }
        const data = await response.json();

        Swal.close();

        if (!data || !data.proveedor) {
          throw new Error('Datos del proveedor no recibidos');
        }
          
        const proveedor = data.proveedor;
        document.getElementById('proveedorId').value = proveedor.id;
        document.getElementById('nombre').value = proveedor.nombre;
        document.getElementById('ruc').value = proveedor.ruc;
        document.getElementById('telefono').value = proveedor.telefono || '';
        document.getElementById('direccion').value = proveedor.direccion;
        document.getElementById('email').value = proveedor.email || '';
        
        myProveedorModal.show();
      } catch (error) {
        Swal.close();
        console.error('Error:', error);
        Swal.fire({
          title: 'Error',
          text: error.message || 'Error al cargar datos del proveedor',
          icon: 'error'
        });
      }
    }

    async function actualizarProveedor(id, formData) {
      Swal.fire({
        title: 'Actualizando...',
        text: 'Por favor, espere.',
        didOpen: () => {
          Swal.showLoading();
        },
        allowOutsideClick: false,
        allowEscapeKey: false
      });

      try {
        const response = await fetch(`/Proveedores/editar/${id}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken
          },
          body: formData
        });

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || 'Error en el servidor');
        }
        const data = await response.json();

        Swal.close();

        cerrarModal();
        Swal.fire({
          title: 'Actualizado',
          text: data.mensaje || 'Proveedor actualizado correctamente',
          icon: 'success'
        });
      } catch (error) {
        Swal.close();
        console.error('Error:', error);
        Swal.fire({
          title: 'Error',
          text: error.message || 'Error al actualizar el proveedor',
          icon: 'error'
        });
      }
    }

    function cerrarModal() {
      if (myProveedorModal) {
        myProveedorModal.hide();
      }
      document.getElementById('formProveedor').reset();
      document.getElementById('proveedorId').value = '';
      listadoProveedores();
    }

    function confirmDelete(id) {
      Swal.fire({
        text: "¿Está seguro de eliminar este proveedor?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Sí, eliminar",
        cancelButtonText: "Cancelar"
      }).then(async (result) => {
        if (result.isConfirmed) {
          Swal.fire({
            title: 'Eliminando...',
            text: 'Por favor, espere.',
            didOpen: () => {
              Swal.showLoading();
            },
            allowOutsideClick: false,
            allowEscapeKey: false
          });

          try {
            const response = await fetch(`/Proveedores/eliminar/${id}/`, {
              method: 'POST',
              headers: {
                'X-CSRFToken': csrftoken
              }
            });

            if (!response.ok) {
              const err = await response.json();
              throw new Error(err.error || 'Error en el servidor');
            }
            const data = await response.json();

            Swal.close();

            listadoProveedores();
            Swal.fire({
              title: 'Eliminado',
              text: data.mensaje || 'Proveedor eliminado correctamente',
              icon: 'success'
            });
          } catch (error) {
            Swal.close();
            console.error('Error:', error);
            Swal.fire({
              title: 'Error',
              text: error.message || 'Error al eliminar el proveedor',
              icon: 'error'
            });
          }
        }
      });
    }
  </script>

  <script>
    $("#formProveedor").validate({
      rules: {
        "nombre": {
          required: true,
          minlength: 3
        },
        "ruc": {
          required: true,
          minlength: 10,
          maxlength: 13
        },
        "direccion": {
          required: true,
          minlength: 5
        },
        "email": {
          email: true
        }
      },
      messages: {
        "nombre": {
          required: "Por favor, ingresa el nombre del proveedor",
          minlength: "Debe tener al menos 3 caracteres"
        },
        "ruc": {
          required: "Por favor, ingresa el RUC",
          minlength: "El RUC debe tener al menos 10 caracteres",
          maxlength: "El RUC no puede exceder los 13 caracteres"
        },
        "direccion": {
          required: "Por favor, ingresa la dirección",
          minlength: "La dirección debe tener al menos 5 caracteres"
        },
        "email": {
          email: "Por favor, ingresa un email válido"
        }
      },
      errorElement: "span",
      errorClass: "error",
      errorPlacement: function(error, element) {
        error.insertAfter(element);
      }
    });
  </script>

  <script>
    $("#foto").fileinput({
      language: "es",
      allowedFileExtensions: ["jpg", "jpeg", "png"],
      showUpload: false,
      dropZoneEnabled: true,
      maxFileSize: 2048, // 2MB
      showPreview: true,
      browseLabel: "Seleccionar imagen",
      removeLabel: "Eliminar",
      initialCaption: "Selecciona una imagen del proveedor",
      showRemove: true,
      showZoom: true
    });
  </script>

  <script>
    // Inicializar DataTable después de cargar los datos
      let table = new DataTable('#tblProveedores', {
      layout: {
          topStart: {
              buttons: ['copy', 'csv', 'excel', 'pdf', 'print']
          }
      },
      language: {
          url: 'https://cdn.datatables.net/plug-ins/2.3.2/i18n/es-ES.json',
      },
  });
  </script>
<style>
  .img-thumbnail {
    width: 120px; /* Ancho deseado */
    height: 120px; /* Alto deseado */
    object-fit: cover; /* Asegura que la imagen cubra el área sin distorsionarse */
    border-radius: 0 !important; /* Elimina cualquier redondeo forzando 0px */
    border: 1px solid #dee2e6; /* Borde sutil para destacar la imagen */
  }
</style>
</body>
<br><br>
{% endblock %}